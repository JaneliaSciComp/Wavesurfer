classdef ChannelsFigure < ws.MCOSFigure & ws.EventSubscriber
    properties  % protected by gentleman's agreement
        %Model  % an Wavesurfer object
        %Controller  % a ChannelsController
        %FigureGH  % the figure graphics handle
        AIsPanel
        AIChannelColTitleText
        AIScaleColTitleText
        AIIsActiveColTitleText        
        AILabelTexts
        AIUnitsEdits
        AIScaleEdits
        AIUnitsTexts
        AIIsActiveCheckboxes
        
        AOsPanel
        AOChannelColTitleText
        AOScaleColTitleText
        AOLabelTexts
        AOUnitsEdits
        AOScaleEdits
        AOUnitsTexts

        DIsPanel
        DIChannelColTitleText
        DIIsActiveColTitleText        
        DILabelTexts
        DIIsActiveCheckboxes
        
        DOsPanel
        DOIsTimedColTitleText        
        DOIsOnColTitleText        
        DOLabelTexts
        DOIsTimedCheckboxes
        DOIsOnRadiobuttons            
    end  % properties
    
    methods
        function self=ChannelsFigure(model,controller)
            self = self@ws.MCOSFigure(model,controller);
            
            % Set the relevant properties of the figure itself
            set(self.FigureGH,'Tag','ChannelsFigure', ...
                              'Units','pixels', ...
                              'Color',get(0,'defaultUIControlBackgroundColor'), ...
                              'Resize','off', ...
                              'Name','Channels...', ...
                              'NumberTitle','off', ...
                              'Menubar','none', ...
                              'Visible','off');
            
            % Create all the "static" controls, set them up, but don't position them
            self.createFixedControls();

            % Set up the tags of the HG objects to match the property names
            self.updateHGObjectTags_();
           
            % Initialize the guidata
            self.updateGuidata_();

            % sync up self to model
            self.update();         
            
            % Subscribe to model events
            model=self.Model;
            if ~isempty(model) ,
                model.subscribeMe(self,'Update','','update');                
                model.subscribeMe(self,'DidSetState','','updateControlProperties');            
                acquisition=model.Acquisition;
                if ~isempty(acquisition) ,
                    acquisition.subscribeMe(self,'DidSetAnalogChannelUnitsOrScales','','updateControlProperties');
                    acquisition.subscribeMe(self,'DidSetIsChannelActive','','updateControlProperties');
                end
                stimulation=model.Stimulation;
                if ~isempty(stimulation) ,
                    stimulation.subscribeMe(self,'DidSetAnalogChannelUnitsOrScales','','updateControlProperties');                    
                    stimulation.subscribeMe(self,'DidSetIsDigitalChannelTimed','','update');               
                    stimulation.subscribeMe(self,'DidSetDigitalOutputStateIfUntimed','','updateControlProperties');               
                end
            end
            
            % make the figure visible
            set(self.FigureGH,'Visible','on');                        
        end

        function self=createFixedControls(self)
            nAIs=self.Model.Acquisition.NAnalogChannels;  % recursion here
            nDIs=self.Model.Acquisition.NDigitalChannels;
            nAOs=self.Model.Stimulation.NAnalogChannels;
            nDOs=self.Model.Stimulation.NDigitalChannels;
            
            %
            % Make the AIs panel
            %
            self.AIsPanel= ...
                uipanel('Parent',self.FigureGH, ...
                        'Tag','AIsPanel', ...
                        'Units','pixels', ...
                        'FontName','Tahoma', ...
                        'FontSize',8, ...
                        'Title','AI Channels');
            
            % make the title row
            self.AIChannelColTitleText= ...
                uicontrol('Parent',self.AIsPanel, ...
                          'Style','text', ...
                          'Units','pixels', ...
                          'FontName','Tahoma', ...
                          'FontSize',8, ...
                          'HorizontalAlignment','left', ...
                          'String','');
            self.AIScaleColTitleText= ...
                uicontrol('Parent',self.AIsPanel, ...
                          'Style','text', ...
                          'Units','pixels', ...
                          'FontName','Tahoma', ...
                          'FontSize',8, ...
                          'HorizontalAlignment','center', ...
                          'String','Scale');
            self.AIIsActiveColTitleText= ...
                uicontrol('Parent',self.AIsPanel, ...
                          'Style','text', ...
                          'Units','pixels', ...
                          'FontName','Tahoma', ...
                          'FontSize',8, ...
                          'HorizontalAlignment','center', ...
                          'String','Active?');
                    
            % Populate the AI channel rows        
            for i=1:nAIs ,
                self.AILabelTexts(i)=...
                    uicontrol('Parent',self.AIsPanel, ...
                              'Style','text', ...
                              'Tag',sprintf('AILabelTexts%d',i), ...
                              'Units','pixels', ...
                              'FontName','Tahoma', ...
                              'FontSize',8, ...
                              'HorizontalAlignment','left');  % shim to make look nice
                self.AIScaleEdits(i)= ...
                    uicontrol('Parent',self.AIsPanel, ...
                              'Style','edit', ...
                              'Tag',sprintf('AIScaleEdits%d',i), ...
                              'Units','pixels', ...
                              'FontName','Tahoma', ...
                              'FontSize',8, ...
                              'BackgroundColor','w', ...
                              'HorizontalAlignment','right', ...
                              'Callback',@(src,evt)(self.controlActuated('AIScaleEdits',src,evt)) );
                self.AIUnitsTexts(i)= ...
                    uicontrol('Parent',self.AIsPanel, ...
                              'Style','text', ...
                              'Tag',sprintf('AIUnitsTexts%d',i), ...
                              'Units','pixels', ...
                              'FontName','Tahoma', ...
                              'FontSize',8, ...
                              'String','V/', ...
                              'HorizontalAlignment','left');
                self.AIUnitsEdits(i)= ...
                    uicontrol('Parent',self.AIsPanel, ...
                              'Style','edit', ...
                              'Tag',sprintf('AIUnitsEdits%d',i), ...
                              'Units','pixels', ...
                              'FontName','Tahoma', ...
                              'FontSize',8, ...
                              'BackgroundColor','w', ...
                              'HorizontalAlignment','left', ...
                              'Callback',@(src,evt)(self.controlActuated('AIUnitsEdits',src,evt)) );
                self.AIIsActiveCheckboxes(i)= ...
                    uicontrol('Parent',self.AIsPanel, ...
                              'Style','checkbox', ...
                              'Units','pixels', ...
                              'FontSize',8, ...
                              'FontName','Tahoma', ...
                              'Value',0, ...
                              'String','', ...
                              'Callback',@(src,evt)(self.controlActuated('AIIsActiveCheckboxes',src,evt)));                          
            end
            
            %
            % Make the AOs panel
            %
            self.AOsPanel= ...
                uipanel('Parent',self.FigureGH, ...
                        'Tag','AOsPanel', ...
                        'Units','pixels', ...
                        'FontName','Tahoma', ...
                        'FontSize',8, ...
                        'Title','AO Channels');
            
            % make the title row
            self.AOChannelColTitleText= ...
                uicontrol('Parent',self.AOsPanel, ...
                          'Style','text', ...
                          'Units','pixels', ...
                          'FontName','Tahoma', ...
                          'FontSize',8, ...
                          'HorizontalAlignment','left', ...
                          'String','');
            self.AOScaleColTitleText= ...
                uicontrol('Parent',self.AOsPanel, ...
                          'Style','text', ...
                          'Units','pixels', ...
                          'FontName','Tahoma', ...
                          'FontSize',8, ...
                          'HorizontalAlignment','left', ...
                          'String','Scale');
%             self.AOMultiplierColTitleText= ...
%                 uicontrol('Parent',self.AOsPanel, ...
%                           'Style','text', ...
%                           'Units','pixels', ...
%                           'FontName','Tahoma', ...
%                           'FontSize',8, ...
%                           'HorizontalAlignment','center', ...
%                           'String','Multiplier');

            % populate the AO rows
            for i=1:nAOs ,
                self.AOLabelTexts(i)=...
                    uicontrol('Parent',self.AOsPanel, ...
                              'Style','text', ...
                              'Tag',sprintf('AOLabelTexts%d',i), ...
                              'Units','pixels', ...
                              'FontName','Tahoma', ...
                              'FontSize',8, ...
                              'HorizontalAlignment','left');
                self.AOScaleEdits(i)= ...
                    uicontrol('Parent',self.AOsPanel, ...
                              'Style','edit', ...
                              'Tag',sprintf('AOScaleEdits%d',i), ...
                              'Units','pixels', ...
                              'FontName','Tahoma', ...
                              'FontSize',8, ...
                              'BackgroundColor','w', ...
                              'HorizontalAlignment','right', ...
                              'Callback',@(src,evt)(self.controlActuated('AOScaleEdits',src,evt)) );
                self.AOUnitsEdits(i)= ...
                    uicontrol('Parent',self.AOsPanel, ...
                              'Style','edit', ...
                              'Tag',sprintf('AOUnitsEdits%d',i), ...
                              'Units','pixels', ...
                              'FontName','Tahoma', ...
                              'FontSize',8, ...
                              'BackgroundColor','w', ...
                              'HorizontalAlignment','right', ...
                              'Callback',@(src,evt)(self.controlActuated('AOUnitsEdits',src,evt)) );
                self.AOUnitsTexts(i)= ...
                    uicontrol('Parent',self.AOsPanel, ...
                              'Style','text', ...
                              'Tag',sprintf('AOUnitsTexts%d',i), ...
                              'Units','pixels', ...
                              'FontName','Tahoma', ...
                              'FontSize',8, ...
                              'String','/V', ...
                              'HorizontalAlignment','left');
%                 self.AOMultiplierEdits(i)= ...
%                     uicontrol('Parent',self.AOsPanel, ...
%                               'Style','edit', ...
%                               'Tag',sprintf('AOMultiplierEdits%d',i), ...
%                               'Units','pixels', ...
%                               'FontName','Tahoma', ...
%                               'FontSize',8, ...
%                               'BackgroundColor','w', ...
%                               'HorizontalAlignment','right', ...
%                               'Callback',@(src,evt)(self.controlActuated(src,evt)) );
            end
            
            %
            % Make the DIs panel
            %
            self.DIsPanel= ...
                uipanel('Parent',self.FigureGH, ...
                        'Tag','DIsPanel', ...
                        'Units','pixels', ...
                        'FontName','Tahoma', ...
                        'FontSize',8, ...
                        'Title','DI Channels');
            
            % make the title row
            self.DIChannelColTitleText= ...
                uicontrol('Parent',self.DIsPanel, ...
                          'Style','text', ...
                          'Units','pixels', ...
                          'FontName','Tahoma', ...
                          'FontSize',8, ...
                          'HorizontalAlignment','left', ...
                          'String','');
            self.DIIsActiveColTitleText= ...
                uicontrol('Parent',self.DIsPanel, ...
                          'Style','text', ...
                          'Units','pixels', ...
                          'FontName','Tahoma', ...
                          'FontSize',8, ...
                          'HorizontalAlignment','center', ...
                          'String','Active?');
                    
            % Populate the DI channel rows        
            for i=1:nDIs ,
                self.DILabelTexts(i)=...
                    uicontrol('Parent',self.DIsPanel, ...
                              'Style','text', ...
                              'Tag',sprintf('DILabelTexts%d',i), ...
                              'Units','pixels', ...
                              'FontName','Tahoma', ...
                              'FontSize',8, ...
                              'HorizontalAlignment','left');  % shim to make look nice
                self.DIIsActiveCheckboxes(i)= ...
                    uicontrol('Parent',self.DIsPanel, ...
                              'Style','checkbox', ...
                              'Units','pixels', ...
                              'FontSize',8, ...
                              'FontName','Tahoma', ...
                              'Value',0, ...
                              'String','', ...
                              'Callback',@(src,evt)(self.controlActuated('DIIsActiveCheckboxes',src,evt)));                          
            end
           
            %
            % Make the DOs panel
            %
            self.DOsPanel= ...
                uipanel('Parent',self.FigureGH, ...
                        'Tag','DOsPanel', ...
                        'Units','pixels', ...
                        'FontName','Tahoma', ...
                        'FontSize',8, ...
                        'Title','DO Channels');
            
            % make the title row
            self.DOIsTimedColTitleText= ...
                uicontrol('Parent',self.DOsPanel, ...
                          'Style','text', ...
                          'Units','pixels', ...
                          'FontName','Tahoma', ...
                          'FontSize',8, ...
                          'HorizontalAlignment','center', ...
                          'String','Timed?');
            self.DOIsOnColTitleText= ...
                uicontrol('Parent',self.DOsPanel, ...
                          'Style','text', ...
                          'Units','pixels', ...
                          'FontName','Tahoma', ...
                          'FontSize',8, ...
                          'HorizontalAlignment','center', ...
                          'String','On?');
                    
            % Populate the DO channel rows        
            for i=1:nDOs ,
                self.DOLabelTexts(i)=...
                    uicontrol('Parent',self.DOsPanel, ...
                              'Style','text', ...
                              'Tag',sprintf('DOLabelTexts%d',i), ...
                              'Units','pixels', ...
                              'FontName','Tahoma', ...
                              'FontSize',8, ...
                              'HorizontalAlignment','left');
                self.DOIsTimedCheckboxes(i)= ...
                    uicontrol('Parent',self.DOsPanel, ...
                              'Style','checkbox', ...
                              'Units','pixels', ...
                              'FontSize',8, ...
                              'FontName','Tahoma', ...
                              'Value',0, ...
                              'String','', ...
                              'Callback',@(src,evt)(self.controlActuated('DOIsTimedCheckboxes',src,evt)));
                self.DOIsOnRadiobuttons(i)= ...
                    uicontrol('Parent',self.DOsPanel, ...
                              'Style','radiobutton', ...
                              'Units','pixels', ...
                              'FontSize',8, ...
                              'FontName','Tahoma', ...
                              'Value',0, ...
                              'String','', ...
                              'Callback',@(src,evt)(self.controlActuated('DOIsOnRadiobuttons',src,evt)));
            end  % loop over DO channel rows
            
        end  % method
        
        function value=maximumAILabelTextWidth(self)
            n=length(self.AILabelTexts);
            value=-inf;
            for i=1:n ,
                thisExtent=get(self.AILabelTexts(i),'Extent');
                thisWidth=thisExtent(3);
                value=max(value,thisWidth);
            end            
        end
        
        function value=maximumAOLabelTextWidth(self)
            n=length(self.AOLabelTexts);            
            value=-inf;
            for i=1:n ,
                thisExtent=get(self.AOLabelTexts(i),'Extent');
                thisWidth=thisExtent(3);
                value=max(value,thisWidth);
            end            
        end
        
        function value=maximumDILabelTextWidth(self)
            n=length(self.DILabelTexts);
            value=-inf;
            for i=1:n ,
                thisExtent=get(self.DILabelTexts(i),'Extent');
                thisWidth=thisExtent(3);
                value=max(value,thisWidth);
            end            
        end
        
        function value=maximumDOLabelTextWidth(self)
            n=length(self.DOLabelTexts);            
            value=-inf;
            for i=1:n ,
                thisExtent=get(self.DOLabelTexts(i),'Extent');
                thisWidth=thisExtent(3);
                value=max(value,thisWidth);
            end            
        end
        
        function self=layout(self)
            import ws.utility.*

            % Layout parameters
            panelBorderSize=6;
            interPanelSpaceWidth=10;
            interPanelSpaceHeight=10;
            panelToTitleRowSpaceHeight=20;  % need to accomodate the panel title
            bottomRowToFrameSpaceHeight=12;
            titleRowHeight=10;
            rowHeight=16;
            interRowHeight=10;
            rowToRowHeight=rowHeight+interRowHeight;
            panelToLabelSpaceWidth=5;
            diLabelWidthWanted=max(30,self.maximumDILabelTextWidth());            
            aiLabelWidthWanted=max(30,self.maximumAILabelTextWidth());
            outputLabelWidth=max(diLabelWidthWanted,aiLabelWidthWanted);            
            aiLabelWidth=outputLabelWidth;            
            editShimHeight=5;
            editHeight=rowHeight+editShimHeight;  % shim makes it look nicer
            gainEditWidth=42;
            aiUnitsNumeratorTextWidth=12;
            aiUnitsEditWidth=25;
            labelHeight=rowHeight;
            aiPanelRightPadWidth=2;
            spaceBetweenLabelAndRestWidth=3;
            gainUnitSpaceWidth=4;
            interUnitsSpaceWidth=0;            
            doLabelWidthWanted=max(30,self.maximumDOLabelTextWidth());            
            aoLabelWidthWanted=max(30,self.maximumAOLabelTextWidth());
            outputLabelWidth=max(doLabelWidthWanted,aoLabelWidthWanted);            
            aoLabelWidth=outputLabelWidth;            
            aoUnitsDenominatorTextWidth=12;
            spaceBeforeIsActiveColWidth=1;
            aiIsActiveColWidth=50;
            spaceBelowTitleRowHeight=2;
            spaceBeforeAOMultiplierColWidth=0;
            aoMultiplierEditWidth=0;
            
            % Derived layout parameters
            nAIs=length(self.AIScaleEdits);
            nAOs=length(self.AOScaleEdits);            
            nDIs=length(self.DILabelTexts);            
            nDOs=length(self.DOLabelTexts);            
            nAnalogRows=max(nAIs,nAOs);
            nDigitalRows=max(nDIs,nDOs);
            aoUnitsEditWidth=aiUnitsEditWidth;
            aoPanelRightPadWidth=8;
            aiPanelWidth = ...
                panelToLabelSpaceWidth+...
                aiLabelWidth+ ...
                spaceBetweenLabelAndRestWidth+ ...
                gainEditWidth+ ...
                gainUnitSpaceWidth+ ...
                aiUnitsNumeratorTextWidth+ ...
                interUnitsSpaceWidth+ ...
                aiUnitsEditWidth+ ...
                spaceBeforeIsActiveColWidth + ...
                aiIsActiveColWidth+ ...
                aiPanelRightPadWidth;
            aoScaleAndUnitsControlsWidth = ...
                gainEditWidth+ ...
                gainUnitSpaceWidth+ ...
                aoUnitsEditWidth+ ...
                interUnitsSpaceWidth+ ...
                aoUnitsDenominatorTextWidth+ ...
                spaceBeforeAOMultiplierColWidth+ ...
                aoMultiplierEditWidth ;
            aoPanelWidth=panelToLabelSpaceWidth+...
                         aoLabelWidth+ ...
                         spaceBetweenLabelAndRestWidth+ ...
                         aoScaleAndUnitsControlsWidth + ...
                         aoPanelRightPadWidth;
            analogPanelsHeight=panelToTitleRowSpaceHeight+titleRowHeight+spaceBelowTitleRowHeight + ...
                               max(0,(nAnalogRows-1))*interRowHeight+nAnalogRows*rowHeight + ...
                               bottomRowToFrameSpaceHeight;
            digitalPanelsHeight=panelToTitleRowSpaceHeight+titleRowHeight+spaceBelowTitleRowHeight + ...
                                max(0,(nDigitalRows-1))*interRowHeight+nDigitalRows*rowHeight + ...
                                 bottomRowToFrameSpaceHeight;
            figureHeight=panelBorderSize+analogPanelsHeight+interPanelSpaceHeight+digitalPanelsHeight+panelBorderSize;
            figureWidth=panelBorderSize+aiPanelWidth+interPanelSpaceWidth+aoPanelWidth+panelBorderSize;
            
            % Position the figure, keeping upper left corner fixed
            currentPosition=get(self.FigureGH,'Position');
            currentOffset=currentPosition(1:2);
            currentSize=currentPosition(3:4);
            currentUpperY=currentOffset(2)+currentSize(2);
            figurePosition=[currentOffset(1) currentUpperY-figureHeight figureWidth figureHeight];
            set(self.FigureGH,'Position',figurePosition);
            
            % Position the AIs panel
            set(self.AIsPanel,'Position',[panelBorderSize panelBorderSize+digitalPanelsHeight+interPanelSpaceHeight aiPanelWidth analogPanelsHeight]);
            
            %  Layout the row of column titles in AI panel
            titleRowBottomY=analogPanelsHeight-panelToTitleRowSpaceHeight-titleRowHeight;
            channelLabelColLeftX = panelToLabelSpaceWidth;
            ws.utility.alignTextInRectangleBang(self.AIChannelColTitleText,[channelLabelColLeftX titleRowBottomY aiLabelWidth titleRowHeight],'lm');
            gainColLeftX = channelLabelColLeftX+aiLabelWidth+spaceBetweenLabelAndRestWidth;
            ws.utility.alignTextInRectangleBang(self.AIScaleColTitleText,[gainColLeftX titleRowBottomY gainEditWidth titleRowHeight],'cm');
            isActiveColLeftX=gainColLeftX+gainEditWidth+gainUnitSpaceWidth+ ...
                             aiUnitsNumeratorTextWidth+ ...
                             interUnitsSpaceWidth+ ...
                             aiUnitsEditWidth+spaceBeforeIsActiveColWidth;
            ws.utility.alignTextInRectangleBang(self.AIIsActiveColTitleText,[isActiveColLeftX titleRowBottomY aiIsActiveColWidth titleRowHeight],'cm');
            
            % Position the stuff in the AI rows            
            aiYRowBottom=titleRowBottomY-spaceBelowTitleRowHeight-rowHeight;   
            for i=1:nAIs ,
                xColLeft=panelToLabelSpaceWidth;
                set(self.AILabelTexts(i), ...
                    'Position',[xColLeft aiYRowBottom-4 aiLabelWidth labelHeight]);  % shim to make look nice
                xColLeft=xColLeft+aiLabelWidth+spaceBetweenLabelAndRestWidth;
                set(self.AIScaleEdits(i), ...
                    'Position',[xColLeft aiYRowBottom-editShimHeight gainEditWidth editHeight]);
                xColLeft=xColLeft+gainEditWidth+gainUnitSpaceWidth;
                set(self.AIUnitsTexts(i), ...
                    'Position',[xColLeft aiYRowBottom-4 aiUnitsNumeratorTextWidth labelHeight]);
                xColLeft=xColLeft+aiUnitsNumeratorTextWidth+interUnitsSpaceWidth;
                set(self.AIUnitsEdits(i), ...
                    'Position',[xColLeft aiYRowBottom-editShimHeight aiUnitsEditWidth editHeight] );
                xColLeft=xColLeft+aiUnitsEditWidth+spaceBeforeIsActiveColWidth;
                centerCheckboxBang(self.AIIsActiveCheckboxes(i),[xColLeft+aiIsActiveColWidth/2 aiYRowBottom+rowHeight/2]);
                aiYRowBottom=aiYRowBottom-rowToRowHeight;
            end
            
            % Position the AOs panel
            set(self.AOsPanel, ...
                'Position',[panelBorderSize+aiPanelWidth+interPanelSpaceWidth panelBorderSize+digitalPanelsHeight+interPanelSpaceHeight aoPanelWidth analogPanelsHeight] );

            %  Layout the row of column titles in AO panel
            channelLabelColLeftX = panelToLabelSpaceWidth;
            alignTextInRectangleBang(self.AOChannelColTitleText,[channelLabelColLeftX titleRowBottomY aoLabelWidth titleRowHeight],'lm');
            gainColLeftX = channelLabelColLeftX+aoLabelWidth+spaceBetweenLabelAndRestWidth;
            alignTextInRectangleBang(self.AOScaleColTitleText,[gainColLeftX titleRowBottomY gainEditWidth titleRowHeight],'cm');
%             multiplierColLeftX=gainColLeftX+ ...
%                                gainEditWidth+ ...
%                                gainUnitSpaceWidth+ ...
%                                aoUnitsEditWidth+ ...
%                                interUnitsSpaceWidth+ ...
%                                aoUnitsDenominatorTextWidth+ ...
%                                spaceBeforeAOMultiplierColWidth;
%             alignTextInRectangleBang(self.AOMultiplierColTitleText,[multiplierColLeftX titleRowBottomY aoMultiplierEditWidth titleRowHeight],'cm');            

            % Position the stuff in the AO rows                        
            aoYRowBottom=titleRowBottomY-spaceBelowTitleRowHeight-rowHeight;   
            for i=1:nAOs ,
                xColLeft=panelToLabelSpaceWidth;
                set(self.AOLabelTexts(i), ...
                    'Position',[xColLeft aoYRowBottom-4 aoLabelWidth labelHeight] );
                xColLeft=xColLeft+aoLabelWidth+spaceBetweenLabelAndRestWidth;
                set(self.AOScaleEdits(i), ...
                    'Position',[xColLeft aoYRowBottom-editShimHeight gainEditWidth editHeight] );
                xColLeft=xColLeft+gainEditWidth+gainUnitSpaceWidth;
                set(self.AOUnitsEdits(i), ...
                    'Position',[xColLeft aoYRowBottom-editShimHeight aoUnitsEditWidth editHeight] );
                xColLeft=xColLeft+aoUnitsEditWidth+interUnitsSpaceWidth;
                set(self.AOUnitsTexts(i), ...
                    'Position',[xColLeft aoYRowBottom-4 aoUnitsDenominatorTextWidth labelHeight] );
%                 xColLeft=xColLeft+aoUnitsDenominatorTextWidth+spaceBeforeAOMultiplierColWidth;
%                 set(self.AOMultiplierEdits(i), ...
%                     'Position',[xColLeft aoYRowBottom-editShimHeight aoMultiplierEditWidth editHeight] );                
                aoYRowBottom=aoYRowBottom-rowToRowHeight;
            end
            
            % Position the DIs panel
            set(self.DIsPanel,'Position',[panelBorderSize panelBorderSize aiPanelWidth digitalPanelsHeight]);
            
            %  Layout the row of column titles in DI panel
            titleRowBottomY=digitalPanelsHeight-panelToTitleRowSpaceHeight-titleRowHeight;
            channelLabelColLeftX = panelToLabelSpaceWidth;
            ws.utility.alignTextInRectangleBang(self.DIChannelColTitleText,[channelLabelColLeftX titleRowBottomY gainEditWidth titleRowHeight],'cm');
            %isActiveColLeftX=channelLabelColLeftX+aiLabelWidth+spaceBeforeIsActiveColWidth;
            ws.utility.alignTextInRectangleBang(self.DIIsActiveColTitleText,[isActiveColLeftX titleRowBottomY aiIsActiveColWidth titleRowHeight],'cm');
            
            % Position the stuff in the DI rows            
            aiYRowBottom=titleRowBottomY-spaceBelowTitleRowHeight-rowHeight;   
            for i=1:nDIs ,
                %xColLeft=panelToLabelSpaceWidth;
                set(self.DILabelTexts(i), ...
                    'Position',[channelLabelColLeftX aiYRowBottom-4 aiLabelWidth labelHeight]);  % shim to make look nice
                %xColLeft=xColLeft+aiLabelWidth+spaceBeforeIsActiveColWidth;
                centerCheckboxBang(self.DIIsActiveCheckboxes(i),[isActiveColLeftX+aiIsActiveColWidth/2 aiYRowBottom+rowHeight/2]);
                aiYRowBottom=aiYRowBottom-rowToRowHeight;
            end
            
            % Layout the DO panel
            self.layoutDOPanel_(panelBorderSize, ...
                                aiPanelWidth, ...
                                interPanelSpaceWidth, ...
                                aoPanelWidth, ...
                                digitalPanelsHeight, ...
                                panelToTitleRowSpaceHeight, ...
                                titleRowHeight, ...
                                panelToLabelSpaceWidth, ...
                                spaceBelowTitleRowHeight, ...
                                rowHeight, ...
                                interRowHeight, ...
                                outputLabelWidth, ...
                                spaceBetweenLabelAndRestWidth, ...                                
                                aoScaleAndUnitsControlsWidth);
        end  % method
    end  % methods
    
    methods (Access=protected)
        function layoutDOPanel_(self, ...
                                panelBorderSize, ...
                                aiPanelWidth, ...
                                interPanelSpaceWidth, ...
                                aoPanelWidth, ...
                                digitalPanelsHeight, ...
                                panelToTitleRowSpaceHeight, ...
                                titleRowHeight, ...
                                panelToLabelSpaceWidth, ...
                                spaceBelowTitleRowHeight, ...
                                rowHeight, ...
                                interRowHeight, ...
                                outputLabelWidth, ...
                                spaceBetweenLabelAndRestWidth, ...
                                aoScaleAndUnitsControlsWidth)
                            
            % Define constants     
            nDOs = length(self.DOLabelTexts) ;            
            %spaceBetweenLabelAndRestWidth = 6 ;
            isTimedColWidth = 50 ;
            spaceBetweenTimedAndIsOnColsWidth = 0 ;
            isOnColWidth = 30 ;
            isTimedAndIsOnColCompositeWidth = isTimedColWidth + spaceBetweenTimedAndIsOnColsWidth + isOnColWidth ;
            spaceToCenterIsTimedAndIsOnColCompositeWidth = (aoScaleAndUnitsControlsWidth-isTimedAndIsOnColCompositeWidth)/2;
              % the isTimed and isOn columns, together with the fixed space
              % between them, are treated as a unit, and are centered
              % withing the space for them, which is the width of 
              % aoScaleAndUnitsControlsWidth
            rowToRowHeight=rowHeight+interRowHeight;

            % Position the DOs panel
            panelWidth=aoPanelWidth;
            set(self.DOsPanel,'Position',[panelBorderSize+aiPanelWidth+interPanelSpaceWidth ...
                                          panelBorderSize ...
                                          panelWidth ...
                                          digitalPanelsHeight]);
            
            %  Layout the row of column titles in DO panel
            titleRowBottomY=digitalPanelsHeight-panelToTitleRowSpaceHeight-titleRowHeight;
            channelLabelColLeftX = panelToLabelSpaceWidth;
            isTimedColLeftX=channelLabelColLeftX+outputLabelWidth+spaceBetweenLabelAndRestWidth+spaceToCenterIsTimedAndIsOnColCompositeWidth;
            ws.utility.alignTextInRectangleBang(self.DOIsTimedColTitleText,[isTimedColLeftX titleRowBottomY isTimedColWidth titleRowHeight],'cm');
            isOnColLeftX=isTimedColLeftX+isTimedColWidth+spaceBetweenTimedAndIsOnColsWidth;
            ws.utility.alignTextInRectangleBang(self.DOIsOnColTitleText,[isOnColLeftX titleRowBottomY isOnColWidth titleRowHeight],'cm');
            
            % Position the stuff in the DO rows            
            doYRowBottom=titleRowBottomY-spaceBelowTitleRowHeight-rowHeight;   
            for i=1:nDOs ,
                set(self.DOLabelTexts(i), ...
                    'Position',[channelLabelColLeftX doYRowBottom-4 outputLabelWidth rowHeight]);  % shim to make look nice
                ws.utility.centerCheckboxBang(self.DOIsTimedCheckboxes(i),[isTimedColLeftX+isTimedColWidth/2 doYRowBottom+rowHeight/2]);
                ws.utility.centerCheckboxBang(self.DOIsOnRadiobuttons(i),[isOnColLeftX+isOnColWidth/2 doYRowBottom+rowHeight/2]);
                doYRowBottom=doYRowBottom-rowToRowHeight;
            end
        end  % function
        
        function updateImplementation_(self,varargin)
            % Syncs self with model, making no prior assumptions about what
            % might have changed or not changed in the model.
            %self.updateControlsInExistance();
            self.updateControlProperties();
            self.layout();
        end        

        function updateControlPropertiesImplementation_(self,varargin)
            import ws.utility.*
            model=self.Model;
            if isempty(model) || ~isvalid(model) ,
                return
            end
            
            nAIs=length(self.AIScaleEdits);
            nAOs=length(self.AOScaleEdits);
            nDIs=length(self.DILabelTexts);
            nDOs=length(self.DOLabelTexts);
            isWavesurferIdle=(model.State==ws.ApplicationState.Idle);
            
            % update the AIs
            normalBackgroundColor=[1 1 1];
            warningBackgroundColor=[1 0.8 0.8];
            deviceNames=model.Acquisition.DeviceNames;  % cell array of strings
            channelIDs=model.Acquisition.AnalogChannelIDs;  % zero-based NI channel index
            channelNames=model.Acquisition.AnalogChannelNames;
            channelScales=model.Acquisition.AnalogChannelScales;
            channelUnits=model.Acquisition.AnalogChannelUnits;
            nElectrodesClaimingChannel=model.Acquisition.getNumberOfElectrodesClaimingAnalogChannel();
            isChannelScaleEnslaved=(nElectrodesClaimingChannel==1);
            isChannelOvercommited=(nElectrodesClaimingChannel>1);
            for i=1:nAIs ,
                set(self.AILabelTexts(i),'String',sprintf('%s/ai%d (%s):',deviceNames{i},channelIDs(i),channelNames{i}));                
                set(self.AIScaleEdits(i),'String',sprintf('%g',channelScales(i)), ...
                                         'BackgroundColor',fif(isChannelOvercommited(i),warningBackgroundColor,normalBackgroundColor), ...
                                         'Enable',onIff(isWavesurferIdle&&~isChannelScaleEnslaved(i)));
                set(self.AIUnitsEdits(i),'String',toString(channelUnits(i)), ...
                                         'BackgroundColor',fif(isChannelOvercommited(i),warningBackgroundColor,normalBackgroundColor), ...
                                         'Enable',onIff(isWavesurferIdle&&~isChannelScaleEnslaved(i)));
                set(self.AIIsActiveCheckboxes(i),'Value',self.Model.Acquisition.IsAnalogChannelActive(i), ...
                                                 'Enable',onIff(isWavesurferIdle));                                     
            end
            
            % update the AOs
            physicalChannelNames = model.Stimulation.AnalogPhysicalChannelNames ;
            %deviceNames=model.Stimulation.DeviceNamePerAnalogChannel;  % cell array of strings
            %channelIDs=model.Stimulation.AnalogChannelIDs;  % zero-based NI channel index
            channelNames=model.Stimulation.AnalogChannelNames;
            channelScales=model.Stimulation.AnalogChannelScales;
            channelUnits=model.Stimulation.AnalogChannelUnits;
            nElectrodesClaimingChannel=model.Stimulation.getNumberOfElectrodesClaimingChannel();
            isChannelScaleEnslaved=(nElectrodesClaimingChannel==1);
            isChannelOvercommited=(nElectrodesClaimingChannel>1);
            for i=1:nAOs ,
                %set(self.AOLabelTexts(i),'String',sprintf('%s/ao%d (%s):',deviceNames{i},channelIDs(i),channelNames{i}));                
                set(self.AOLabelTexts(i),'String',sprintf('%s (%s):',physicalChannelNames{i},channelNames{i}));                
                set(self.AOScaleEdits(i),'String',sprintf('%g',channelScales(i)), ...
                                         'BackgroundColor',fif(isChannelOvercommited(i),warningBackgroundColor,normalBackgroundColor), ...
                                         'Enable',onIff(isWavesurferIdle&&~isChannelScaleEnslaved(i)));
                set(self.AOUnitsEdits(i),'String',toString(channelUnits(i)), ...
                                         'BackgroundColor',fif(isChannelOvercommited(i),warningBackgroundColor,normalBackgroundColor), ...
                                         'Enable',onIff(isWavesurferIdle&&~isChannelScaleEnslaved(i)));
            end
            
            % update the DIs
            physicalChannelNames = model.Acquisition.DigitalPhysicalChannelNames ;
            channelNames=model.Acquisition.DigitalChannelNames;
            for i=1:nDIs ,
                set(self.DILabelTexts(i),'String',sprintf('%s (%s):',physicalChannelNames{i},channelNames{i}));                
                set(self.DIIsActiveCheckboxes(i),'Value',self.Model.Acquisition.IsDigitalChannelActive(i), ...
                                                 'Enable',onIff(isWavesurferIdle));                                     
            end
            
            % update the DOs
            physicalChannelNames = model.Stimulation.DigitalPhysicalChannelNames ;
            channelNames=model.Stimulation.DigitalChannelNames;
            isTimed=model.Stimulation.IsDigitalChannelTimed;
            for i=1:nDOs ,
                set(self.DOLabelTexts(i),'String',sprintf('%s (%s):',physicalChannelNames{i},channelNames{i}));                
                set(self.DOIsTimedCheckboxes(i),'value',self.Model.Stimulation.IsDigitalChannelTimed(i),...
                                                'enable',onIff(isWavesurferIdle));
                set(self.DOIsOnRadiobuttons(i),'value',self.Model.Stimulation.DigitalOutputStateIfUntimed(i),...
                                               'enable',onIff(~isTimed(i)));
            end
            
        end  % function        
        
    end
    
    methods (Access = protected)
        function updateHGObjectTags_(self)
            % For each object property, if it's an HG object, set the tag
            % based on the property name
            mc=metaclass(self);
            propertyNames={mc.PropertyList.Name};
            for i=1:length(propertyNames) ,
                propertyName=propertyNames{i};
                propertyThing=self.(propertyName);
                if ~isempty(propertyThing) && all(ishghandle(propertyThing)) && ~(isscalar(propertyThing) && isequal(get(propertyThing,'Type'),'figure')) ,
                    % Set Tag
                    set(propertyThing,'Tag',propertyName);
                end
            end
        end  % function        
    end  % protected methods block
    
end  % classdef
